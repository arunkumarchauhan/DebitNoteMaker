<div class="modal fade" id="editBillModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form method="POST" action="/bill" id="editBillForm">
        <div class="modal-header">
          <h5 class="modal-title">Add/Edit Bill</h5>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="billIdInput" />
          <input type="hidden" name="company_id" id="companyIdInput" />
          <div class="row g-3">
            <div class="col-md-6">
              <label for="billNumber" class="form-label">Bill Number</label>
              <input
                type="number"
                class="form-control"
                id="billNumber"
                step="1"
                min="0"
                name="bill_number"
                placeholder="Enter Bill Number"
                required
              />
            </div>

            <div class="col-md-6">
              <label for="amount" class="form-label">Amount</label>
              <input
                type="number"
                min="0"
                step="0.01"
                class="form-control"
                id="amount"
                name="amount"
                required
              />
            </div>
            <div class="col-md-6">
              <label for="billDate" class="form-label">Bill Date</label>
              <input
                type="date"
                class="form-control"
                id="billDate"
                name="bill_date"
                required
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            id="closeBillModalButton"
            class="btn btn-outline-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button
            type="submit"
            id="saveBillModalButton"
            class="btn btn-primary"
          >
            Save
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const editModalEl = document.getElementById("editBillModal");
      const closeButton = document.getElementById("closeBillModalButton");

      if (closeButton) {
        closeButton.addEventListener("click", () => {
          if (document.activeElement === closeButton) {
            closeButton.blur();
          }
        });
      }

      if (editModalEl) {
        editModalEl.addEventListener("hide.bs.modal", () => {
          const activeEl = document.activeElement;
          if (activeEl && editModalEl.contains(activeEl)) {
            activeEl.blur();
          }
        });
      }

      if (!editModalEl) {
        return;
      }

      editModalEl.addEventListener("show.bs.modal", function (event) {
        const triggerButton = event.relatedTarget;
        if (!triggerButton) {
          return;
        }

        document.getElementById("companyIdInput").value =
          triggerButton.getAttribute("data-company-id") || "";
        const billId = triggerButton.getAttribute("data-id");
        document.getElementById("billIdInput").value = billId || "";
        const billNumber = triggerButton.getAttribute("data-bill-number");
        document.getElementById("billNumber").value = billNumber || "";
        document.getElementById("amount").value =
          triggerButton.getAttribute("data-amount") || "";
        const billDate = triggerButton.getAttribute("data-bill-date") || "";
        document.getElementById("billDate").value = billDate;
        if (billDate.trim() === "") {
          document.getElementById("billDate").value = new Date()
            .toISOString()
            .split("T")[0];
        }

        var modalTitle = document.querySelector(".modal-title");
        modalTitle.textContent = billId ? `Edit Bill ${billId}` : "Add Bill";
        if (billId) {
          document
            .getElementById("billNumber")
            .setAttribute("readonly", "readonly");
        } else {
          document.getElementById("billNumber").removeAttribute("readonly");
        }
      });
    });
  </script>
  <script>
    document
      .getElementById("editBillForm")
      .addEventListener("submit", function (e) {
        e.preventDefault(); // Stop the default form submission

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());
        const actionUrl = this.getAttribute("action");

        const requestMethod =
          data.id == null || data.id === "" ? "POST" : "PATCH";
          if( data.id === ""){

          data.id = parseInt(data.id);
        }


        console.log("Data:", data);
        fetch(actionUrl, {
          method: requestMethod,
          headers: {
            "Content-Type": "application/json", // Or 'application/x-www-form-urlencoded'
            // Add any necessary headers, e.g., X-CSRF-TOKEN
          },
          body: JSON.stringify(data), // Send data as JSON
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Success:", data);
            if (data.detail) {
              alert(data.detail);
            } else {
              const closeBillModalButton = document.getElementById(
                "closeBillModalButton"
              );
              if (closeBillModalButton) {
                closeBillModalButton.click();
              }
            }

            window.location.reload();
            // Handle success (e.g., show a confirmation message)
          })
          .catch((error) => {
            console.error("Error:", error);
            // Handle errors
          });
      });
  </script>
</div>
