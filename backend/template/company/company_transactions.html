{% extends "base.html" %}
 {% block title %}
<title>Company Transactions - {{ company.name }}</title>

{% endblock %}
 {% block content %}
{% set transactions = bill.transactions if
bill and bill.transactions is defined else [] %} 
{% set transaction_count =
(transactions | selectattr('amount_paid', 'gt', 0) | list | length) %} 
{% set
mdash = "&mdash;"|safe %}

<div class="container py-4">
  <div
    class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4"
  >
    <div>
      <h2 class="mb-1">{{ company.name }}</h2>
      <p class="text-muted mb-0">
        GST: {% if company.gst_number %} {{ company.gst_number }} {% else %}
        &mdash; {% endif %} &middot; Payment Term: {{ company.payment_term_days
        }} days
      </p>
    </div>
    <div class="mt-3 mt-md-0">
      <a
        href="javascript:history.back()"
        class="btn btn-outline-secondary btn-sm"
        >Back</a
      >
    </div>
  </div>

  <div class="row g-3 mb-4">
    <div class="col-lg-6">
      <div class="card h-100">
        <div class="card-header">
          <h5 class="mb-0">Company Details</h5>
        </div>
        <div class="card-body">
          <div class="row gy-2">
            <div class="col-sm-6">
              <small class="text-muted text-uppercase d-block">Email</small>
              <span class="fw-semibold">
                {% if company.email %} {{ company.email }} {% else %} &mdash; {%
                endif %}
              </span>
            </div>
            <div class="col-sm-6">
              <small class="text-muted text-uppercase d-block">Phone</small>
              <span class="fw-semibold">
                {% if company.phone_number %} {{ company.phone_number }} {% else
                %} &mdash; {% endif %}
              </span>
            </div>
            <div class="col-sm-6">
              <small class="text-muted text-uppercase d-block"
                >GST Number</small
              >
              <span class="fw-semibold">
                {% if company.gst_number %} {{ company.gst_number }} {% else %}
                &mdash; {% endif %}
              </span>
            </div>
            <div class="col-sm-6">
              <small class="text-muted text-uppercase d-block"
                >Payment Term</small
              >
              <span class="fw-semibold"
                >{{ company.payment_term_days }} days</span
              >
            </div>
            {% if company.address %}
            <div class="col-12">
              <small class="text-muted text-uppercase d-block">Address</small>
              <span class="fw-semibold">{{ company.address }}</span>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card h-100">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="mb-0">Bill Summary</h5>
          <span class="badge text-bg-light">ROI {{ bill.interest }}%</span>
        </div>
        <div class="card-body">
          <div class="row text-center gy-3">
            <div class="col-sm-6">
              <small class="text-muted text-uppercase d-block"
                >Total Penalty</small
              >
              <span class="fw-semibold fs-5 text-danger"
                >&#8377; {{ "%.2f"|format(bill.total_penalty) }}</span
              >
            </div>
            <div class="col-sm-6">
              <small class="text-muted text-uppercase d-block"
                >Interest Rate</small
              >
              <span class="fw-semibold fs-5">{{ bill.interest }}% p.m.</span>
            </div>
            <div class="col-sm-6">
              <small class="text-muted text-uppercase d-block"
                >Total Amount</small
              >
              <span class="fw-semibold fs-5"
                >&#8377; {{ "%.2f"|format(bill.total_amount) }}</span
              >
            </div>
            <div class="col-sm-6">
              <small class="text-muted text-uppercase d-block"
                >Pending Amount</small
              >
              <span class="fw-semibold fs-5 text-warning"
                >&#8377; {{ "%.2f"|format(bill.pending_amount) }}</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0">
        Transactions
        <span class="badge text-bg-secondary ml-2"
          >{{ transaction_count }}</span
        >
      </h5>
      <button
        type="button"
        class="btn btn-sm btn-outline-primary edit-transaction-btn"
        data-bs-toggle="modal"
        data-bs-target="#editTransactionModal"
      >
        <i class="bi bi-plus-square"></i>
      </button>
    </div>
    <div class="card-body">
      {% if transactions %}
      <div class="table-responsive">
        <table class="table table-striped table-bordered align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th scope="col">Bill No.</th>
              <th scope="col">Bill Date</th>
              <th scope="col">Transaction ID</th>
              <!-- <th scope="col">Payment Mode</th> -->
              <th scope="col">Bill Amount</th>
              <th scope="col">Amount Paid</th>
              <th scope="col">Pending Amount</th>
              <th scope="col">Payment Date</th>
              <th scope="col">Delayed Days</th>
              <th scope="col">Penalty</th>

              <th scope="col" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for txn in transactions %}
            <tr>
              <td>{{ txn.bill_number }}</td>

              <td>
                {% if txn.bill_date %} {{ txn.bill_date |
                format_datetime('%d-%m-%Y')}} {% else %} &mdash; {% endif %}
              </td>
              <td>{{ txn.id if txn.id else mdash }}</td>
              <!-- <td>{{ txn.payment_mode if txn.payment_mode else mdash }}</td> -->
              <td>
                {% if txn.bill_amount is not none %} &#8377; {{
                "%.2f"|format(txn.bill_amount) }} {% else %} &mdash; {% endif %}
              </td>
              <td>&#8377; {{ "%.2f"|format(txn.amount_paid) }}</td>
              <td>&#8377; {{ "%.2f"|format(txn.pending_amount) }}</td>
              <td>
                {% if txn.payment_date %} {{ txn.payment_date |
                format_datetime('%d-%m-%Y') }} {% else %} &mdash; {% endif %}
              </td>
              <td>{{ txn.delayed_days }}</td>
              <td class="text-danger">
                &#8377; {{ "%.2f"|format(txn.penalty) }}
              </td>
              <td class="text-center">
                {% if txn.id %}
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary edit-transaction-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#editTransactionModal"
                  data-id="{{ txn.id }}"
                  data-bill-id="{{ txn.bill_id }}"
                  data-payment-mode="{{ txn.payment_mode or '' }}"
                  data-bill-number="{{ txn.bill_number }}"
                  data-amount="{{ '%.2f'|format(txn.amount_paid) }}"
                  data-payment-date="{% if txn.payment_date %}{{ txn.payment_date | format_datetime('%Y-%m-%d') }}{% endif %}"
                  data-description="{{ txn.description or '' }}"
                  data-bank-transaction-id="{{ txn.transaction_id }}"
                >
                  <i class="bi bi-pencil-square"></i>
                </button>
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  onclick="showDeleteTransactionConfirmation('{{ txn.id }}')"
                >
                  <i class="bi bi-trash"></i>
                </button>
                {% else %}
                <span class="text-muted">&mdash;</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="mb-0 text-muted">
        No transactions recorded for this company yet.
      </p>
      {% endif %}
    </div>
  </div>
</div>
<script>
  function showDeleteTransactionConfirmation(txnId) {
    if (
      confirm(
        `Are you sure you want to delete transaction with id:  ${txnId} ?`
      )
    ) {
      // User clicked "OK"
      // alert("Item deleted!");

      const actionUrl = "/transaction/" + txnId;

      fetch(actionUrl, {
        method: "DELETE",
        headers: {
          "Content-Type": "application/json", // Or 'application/x-www-form-urlencoded'
          // Add any necessary headers, e.g., X-CSRF-TOKEN
        },
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("Success:", data);
          alert("Transaction deleted successfully.");
          window.location.reload();
        })
        .catch((error) => {
          console.error("Error:", error);
          // Handle errors
        });
      // Here you would typically perform the action, e.g., submit a form or make an API call
    }
  }
</script>
{% include 'transactions/edit_transaction_modal.html' %} {% endblock %}
